name: Rebase main onto upstream-main (apply patches)

on:
  schedule:
    - cron: "15 */6 * * *"   # æ”¾åœ¨ upstream-main åŒæ­¥ä¹‹åŽï¼ˆæ¯”å¦‚ 0 */6ï¼‰
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  rebase:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout downstream main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Fetch upstream-main
        run: |
          git fetch origin upstream-main:upstream-main

      - name: Check if upstream-main is already included in main
        id: check
        run: |
          set -e
          # If upstream-main is an ancestor of main, main already contains latest upstream.
          if git merge-base --is-ancestor upstream-main main; then
            echo "âœ… main already contains upstream-main (no upstream update to apply). Skipping."
            echo "skipped=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ðŸš€ upstream-main has new commits not in main. Proceeding with rebase."
          echo "skipped=false" >> "$GITHUB_OUTPUT"

      - name: Create sync branch
        id: branch
        if: steps.check.outputs.skipped != 'true'
        run: |
          set -e
          git config user.name "lunan-org-bot"
          git config user.email "actions@users.noreply.github.com"

          ts=$(date -u +%Y%m%d-%H%M%S)
          SYNC_BRANCH="sync/rebase-${ts}"
          echo "SYNC_BRANCH=${SYNC_BRANCH}" >> $GITHUB_ENV
          echo "sync_branch=${SYNC_BRANCH}" >> $GITHUB_OUTPUT

          git checkout -b "$SYNC_BRANCH"

      - name: Rebase onto upstream-main
        if: steps.check.outputs.skipped != 'true'
        run: |
          set -e
          git rebase upstream-main --committer-date-is-author-date

      - name: Push sync branch
        if: steps.check.outputs.skipped != 'true'
        run: |
          set -e
          git push -u origin "${{ env.SYNC_BRANCH }}"

      - name: Open PR back to main
        if: steps.check.outputs.skipped != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ env.SYNC_BRANCH }}
          base: main
          title: "chore(sync): rebase main onto upstream-main"
          body: |
            Automated rebase of downstream patches onto latest upstream-main.
            - Source: upstream-main
            - Target: main
          labels: upstream-sync

  on_failure:
    needs: rebase
    if: ${{ needs.rebase.result == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "Patch rebase failed (conflicts) - manual intervention needed",
              body: "The scheduled rebase of `main` onto `upstream-main` failed due to conflicts. Please run rebase locally and push a fix.",
              labels: ["upstream-sync", "conflict"]
            })