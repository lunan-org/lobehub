name: Release Desktop Stable

# ============================================
# Stable é¢‘é“å‘ç‰ˆå·¥ä½œæµï¼ˆGitHub Releasesï¼‰
# ============================================
# è§¦å‘æ¡ä»¶:
#   - push tag: v*.*.*  (ä¾‹å¦‚ v2.0.0)
#   - workflow_dispatch: æ‰‹åŠ¨è¾“å…¥ version
#
# Stable åˆ¤å®š:
#   - ç‰ˆæœ¬å·ä¸åŒ…å« '-' åç¼€ï¼ˆä¾‹å¦‚ 2.0.0 âœ…ï¼Œ2.0.0-beta âŒï¼‰
#
# è¯´æ˜:
#   - æœ¬å·¥ä½œæµä»…å‘å¸ƒåˆ° GitHub Releases
#   - ä¸å†ä¸Šä¼ åˆ° S3 æ›´æ–°æœåŠ¡å™¨
# ============================================

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 2.0.0 or v2.0.0)'
        required: true
        type: string
      build_mac:
        description: 'Build macOS (ARM64)'
        required: false
        type: boolean
        default: true
      build_mac_intel:
        description: 'Build macOS (Intel x64)'
        required: false
        type: boolean
        default: true
      build_windows:
        description: 'Build Windows'
        required: false
        type: boolean
        default: true
      build_linux:
        description: 'Build Linux'
        required: false
        type: boolean
        default: true
      skip_github_release:
        description: 'Skip GitHub release upload (for testing)'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

# é»˜è®¤åªè¯»ï¼Œå…·ä½“éœ€è¦å†™æƒé™çš„ job å•ç‹¬å£°æ˜
permissions:
  contents: read

env:
  NODE_VERSION: '24.11.1'

jobs:
  # ============================================
  # æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯ & stable åˆ¤æ–­
  # ============================================
  check-stable:
    name: Check Release Version
    runs-on: ubuntu-latest
    outputs:
      is_stable: ${{ steps.check.outputs.is_stable }}
      version: ${{ steps.check.outputs.version }}
      is_manual: ${{ steps.check.outputs.is_manual }}
      release_notes: ${{ steps.check.outputs.release_notes }}
    steps:
      - name: Check tag / input version
        id: check
        run: |
          set -e

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            version="${{ inputs.version }}"
            version="${version#v}"
            echo "is_manual=true" >> $GITHUB_OUTPUT
            echo "version=${version}" >> $GITHUB_OUTPUT
            echo "release_notes=" >> $GITHUB_OUTPUT
            echo "ğŸ”§ Manual trigger: version=${version}"
          else
            # Tag push è§¦å‘ï¼šä½¿ç”¨ GITHUB_REF_NAMEï¼ˆä¾‹å¦‚ v2.0.0ï¼‰
            version="${GITHUB_REF_NAME}"
            version="${version#v}"
            echo "is_manual=false" >> $GITHUB_OUTPUT
            echo "version=${version}" >> $GITHUB_OUTPUT
            echo "release_notes=" >> $GITHUB_OUTPUT
            echo "ğŸ·ï¸ Tag trigger: version=${version}"
          fi

          # stable ç‰ˆæœ¬åˆ¤å®šï¼šä¸åŒ…å« '-'
          if [[ "$version" == *"-"* ]]; then
            echo "is_stable=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping: ${version} is not a stable release"
          else
            echo "is_stable=true" >> $GITHUB_OUTPUT
            echo "âœ… Stable release detected: ${version}"
          fi

  # ============================================
  # é…ç½®æ„å»ºçŸ©é˜µ
  # ============================================
  configure-build:
    needs: [check-stable]
    if: needs.check-stable.outputs.is_stable == 'true'
    name: Configure Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate Matrix
        id: set-matrix
        run: |
          set -e
          static_matrix='[]'

          # Windows
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]] || [[ "${{ inputs.build_windows }}" == "true" ]]; then
            static_matrix=$(echo "$static_matrix" | jq -c '. + [{"os": "windows-2025", "name": "windows-2025"}]')
          fi

          # Linux
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]] || [[ "${{ inputs.build_linux }}" == "true" ]]; then
            static_matrix=$(echo "$static_matrix" | jq -c '. + [{"os": "ubuntu-latest", "name": "ubuntu-latest"}]')
          fi

          # macOS (ARM64) - GitHub Hosted Runner
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]] || [[ "${{ inputs.build_mac }}" == "true" ]]; then
            echo "Using GitHub-Hosted Runner for macOS ARM64"
            static_matrix=$(echo "$static_matrix" | jq -c '. + [{"os": "macos-15", "name": "macos-arm64"}]')
          fi

          # macOS (Intel x64)
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]] || [[ "${{ inputs.build_mac_intel }}" == "true" ]]; then
            echo "Using GitHub-Hosted Runner for macOS Intel x64"
            static_matrix=$(echo "$static_matrix" | jq -c '. + [{"os": "macos-15-intel", "name": "macos-intel"}]')
          fi

          echo "matrix={\"include\":$static_matrix}" >> $GITHUB_OUTPUT

  # ============================================
  # å¤šå¹³å°æ„å»º
  # ============================================
  build:
    needs: [check-stable, configure-build]
    if: needs.check-stable.outputs.is_stable == 'true'
    name: Build Desktop App
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.configure-build.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup build environment
        uses: ./.github/actions/desktop-build-setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set package version
        run: npm run workflow:set-desktop-version ${{ needs.check-stable.outputs.version }} stable

      # macOS æ„å»ºå‰æ¸…ç† (ä¿®å¤ hdiutil é—®é¢˜ https://github.com/electron-userland/electron-builder/issues/8415)
      - name: Clean previous build artifacts (macOS)
        if: runner.os == 'macOS'
        run: |
          sudo rm -rf apps/desktop/release || true
          sudo rm -rf apps/desktop/dist || true
          sudo rm -rf /tmp/electron-builder* || true

      # macOS æ„å»º
      - name: Build artifact on macOS
        if: runner.os == 'macOS'
        run: npm run desktop:package:app
        env:
          UPDATE_CHANNEL: stable
          RELEASE_NOTES: ${{ needs.check-stable.outputs.release_notes }}
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          CSC_LINK: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CSC_KEY_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          CSC_FOR_PULL_REQUEST: true
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_STABLE_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_STABLE_DESKTOP_BASE_URL }}
          DEBUG_DMG: true

      # Windows æ„å»º
      - name: Build artifact on Windows
        if: runner.os == 'Windows'
        run: npm run desktop:package:app
        env:
          UPDATE_CHANNEL: stable
          RELEASE_NOTES: ${{ needs.check-stable.outputs.release_notes }}
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_STABLE_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_STABLE_DESKTOP_BASE_URL }}
          TEMP: C:\temp
          TMP: C:\temp

      # Linux æ„å»º
      - name: Build artifact on Linux
        if: runner.os == 'Linux'
        run: |
          npm run desktop:package:app
          tar -czf apps/desktop/release/lobehub-renderer.tar.gz -C out .
        env:
          UPDATE_CHANNEL: stable
          RELEASE_NOTES: ${{ needs.check-stable.outputs.release_notes }}
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_STABLE_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_STABLE_DESKTOP_BASE_URL }}

      - name: Upload artifacts
        uses: ./.github/actions/desktop-upload-artifacts
        with:
          artifact-name: release-${{ matrix.name }}

  # ============================================
  # åˆå¹¶ macOS å¤šæ¶æ„æ–‡ä»¶
  # ============================================
  merge-mac-files:
    needs: [build, check-stable]
    if: needs.check-stable.outputs.is_stable == 'true'
    name: Merge macOS Release Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: release
          pattern: release-*
          merge-multiple: true

      - name: List downloaded artifacts
        run: ls -R release

      - name: Install yaml only for merge step
        run: |
          cd scripts/electronWorkflow
          if [ ! -f package.json ]; then
            echo '{"name":"merge-mac-release","private":true}' > package.json
          fi
          bun add --no-save yaml@2.8.1

      - name: Merge latest-mac.yml files
        run: bun run scripts/electronWorkflow/mergeMacReleaseFiles.js

      - name: Upload artifacts with merged macOS files
        uses: actions/upload-artifact@v6
        with:
          name: merged-release
          path: release/
          retention-days: 1

  # ============================================
  # å‘å¸ƒåˆ° GitHub Releases
  # ============================================
  publish-github:
    needs: [merge-mac-files, check-stable]
    if: needs.check-stable.outputs.is_stable == 'true' && !(github.event_name == 'workflow_dispatch' && inputs.skip_github_release)
    name: Publish to GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download merged artifacts
        uses: actions/download-artifact@v7
        with:
          name: merged-release
          path: release

      - name: List final artifacts
        run: ls -R release

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥ version åˆ›å»º tagï¼›tag push æ—¶ä½¿ç”¨ github.ref_nameï¼ˆä¾‹å¦‚ v2.0.0ï¼‰
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', needs.check-stable.outputs.version) || github.ref_name }}
          draft: ${{ github.event_name == 'workflow_dispatch' }}
          files: |
            release/stable*
            release/latest*
            release/*.dmg*
            release/*.zip*
            release/*.exe*
            release/*.AppImage
            release/*.deb*
            release/*.snap*
            release/*.rpm*
            release/*.tar.gz*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}